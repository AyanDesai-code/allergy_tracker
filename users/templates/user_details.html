<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>AllergyTracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'main.css' %}">
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
        <a class="navbar-brand" href="#"><img src="{% static 'images/logo.png' %}" width="60" height="60" alt="logo"></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <button type="button" class="btn btn-primary me-3" data-bs-toggle="modal" data-bs-target="#createAllergyModal">Create Allergy</button>
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#restaurantModal">Create Restaurant</button>
            </ul>

            <form class="d-flex mx-auto position-relative" id="restaurantSearchForm" onsubmit="return false;">
                <input 
                    class="form-control me-2" 
                    type="search" 
                    id="restaurantSearchInput" 
                    placeholder="Search for Restaurants..." 
                    aria-label="Search"
                >
                <div id="searchResults" class="list-group position-absolute w-100 shadow-sm" 
                    style="z-index: 1000; top: 100%; display: none;"></div>
                </form>



            <div class="d-flex ms-auto">
                {% if myuser2 and myuser2.is_authenticated %}
                    <span class="me-3">Hello, {{ myuser2.username }}</span>
                    <a href="{% url 'logout' %}" class="btn btn-outline-danger">Logout</a>
                {% else %}
                    <a href="{% url 'login' %}" class="btn btn-outline-primary me-2">Login</a>
                    <a href="{% url 'login' %}?screen_hint=signup" class="btn btn-primary">Create Account</a>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

<!-- Allergies Section -->
<div class="container mt-4">
    <h3>My Allergies</h3>
    <hr>
    {% if myuser.exists %}
        <div class="alert alert-warning text-center mb-0">You have food allergies! Be cautious when dining out.</div>
    {% else %}
        <div class="alert alert-success text-center mb-0">No known food allergies. Enjoy your meals!</div>
    {% endif %}
    <div id="allergy-cards" class="row">
        {% for allergy in allergies %}
            <div class="card mb-3 col-12" id="allergy-card-{{ allergy.id }}">
                <div class="card-body">
                    <h5 class="card-title">{{ allergy.allergyname }}</h5>
                    <p class="card-text">
                        Test Value: {{ allergy.test_level }}
                        <span class="badge {{ allergy.severity_badge_class }}">{{ allergy.severity }}</span>
                        <button class="btn btn-sm btn-danger delete-allergy-btn" data-id="{{ allergy.id }}">&times;</button>
                    </p>
                </div>
            </div>
        {% empty %}
            
        {% endfor %}
    </div>
</div>

<!-- Create Allergy Modal -->
<div class="modal fade" id="createAllergyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Allergy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if myuser2 and myuser2.is_authenticated %}
                    <form id="createAllergyForm" method="POST" action="{% url 'allergies' myuser2.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="allergyname" class="form-label">Allergy</label>
                            <select class="form-select" id="allergyname" name="allergyname" required>
                                <option value="">Select an allergy</option>
                                <option value="Nuts">Nuts</option>
                                <option value="Fish">Fish</option>
                                <option value="Dairy">Dairy</option>
                                <option value="Eggs">Eggs</option>
                                <option value="Gluten">Gluten</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="test_level" class="form-label">Allergy Test Value</label>
                            <input type="number" step="0.01" class="form-control" id="test_level" name="test_level" required>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Allergy</button>
                        </div>
                    </form>
                {% else %}
                    <p class="text-danger">You must be logged in to add allergies.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Restaurant Cards Section (server-rendered) -->
<div class="container mt-4">
  <h3>My Restaurants</h3>
  <div id="restaurant-cards" class="row">
    {% for restaurant in restaurants %}
      <div class="card mb-3 col-12">
        <div class="card-body">
          <h4 class="card-title">{{ restaurant.name }}</h4>
          <p><strong>Location:</strong> {{ restaurant.location }}</p>
          <p><strong>Description:</strong> {{ restaurant.description }}</p>
          <p><strong>Phone:</strong> {{ restaurant.phone_number }}</p>

          {% for menu in restaurant.menus.all %}
            <div class="ms-3">
              <h5>Menu: {{ menu.name }}</h5>

              {% for section in menu.sections.all %}
                <div class="ms-3">
                  <strong>Section: {{ section.title }}</strong>
                  <ul>
                    {% for food in section.food_set.all %}
                      <li>
                        {{ food.name }}
                        {% if food.allergies.exists %}
                          - Allergens:
                          {% for allergen in food.allergies.all %}
                            {{ allergen.allergen }}{% if not forloop.last %}, {% endif %}
                          {% endfor %}
                        {% endif %}
                      </li>
                    {% empty %}
                      <li class="text-muted">No foods in this section.</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% empty %}
      
    {% endfor %}
  </div>
</div>

<!-- Restaurant Modal (create) -->
<div class="modal fade" id="restaurantModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content rounded-3 shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title">Add Restaurant with Menus & Foods</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if myuser2 and myuser2.is_authenticated %}
                    <form id="restaurantForm">
                        {% csrf_token %}
                        <ul class="nav nav-tabs" id="restaurantTabs">
                            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#restaurant">Restaurant</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#menu">Menu</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#section">Section</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#food">Food</button></li>
                        </ul>

                        <div class="tab-content mt-3">
                            <div class="tab-pane fade show active" id="restaurant">
                                <div class="mb-3">
                                    <label class="form-label">Restaurant Name</label>
                                    <input type="text" id="restaurantName" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Location</label>
                                    <input type="text" id="restaurantLocation" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea id="restaurantDescription" class="form-control"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" id="restaurantPhone" class="form-control">
                                </div>
                            </div>

                            <div class="tab-pane fade" id="menu">
                                <div id="menuList">
                                    <div class="mb-3 menu-item">
                                        <label class="form-label">Menu Name</label>
                                        <input type="text" class="form-control menuNameInput" required>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="addMenuBtn">Add Another Menu</button>
                            </div>

                            <div class="tab-pane fade" id="section">
                                <div id="sectionList">
                                    <div class="mb-3 section-item">
                                        <label class="form-label">Section Title</label>
                                        <input type="text" class="form-control sectionTitleInput" required>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="addSectionBtn">Add Another Section</button>
                            </div>

                            <div class="tab-pane fade" id="food">
                                <div id="foodList">
                                    <div class="mb-3 food-item">
                                        <label class="form-label">Food Name</label>
                                        <input type="text" class="form-control foodNameInput" required>

                                        <label class="form-label mt-2">Allergens</label>
                                        <select class="form-select foodAllergensSelect" multiple>
                                            <option value="">Select an allergy</option>
                                            <option value="Nuts">Nuts</option>
                                            <option value="Fish">Fish</option>
                                            <option value="Dairy">Dairy</option>
                                            <option value="Eggs">Eggs</option>
                                            <option value="Gluten">Gluten</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="addFoodBtn">Add Another Food</button>
                            </div>
                        </div>
                    </form>
                {% else %}
                    <div class="alert alert-warning text-center mb-0">You must be logged in to add restaurants.</div>
                {% endif %}
            </div>

            <div class="modal-footer">
                {% if myuser2 and myuser2.is_authenticated %}
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveRestaurantBtn">Save Restaurant</button>
                {% else %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS file if you want -->
<script src="{% static 'main.js' %}"></script>

{% if myuser2 and myuser2.id %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // ---- Allergy creation ----
    const allergyForm = document.getElementById("createAllergyForm");
    if (allergyForm) {
        allergyForm.addEventListener("submit", function(e) {
            e.preventDefault();
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const payload = {
                allergyname: document.getElementById("allergyname").value,
                test_level: document.getElementById("test_level").value
            };
            fetch("{% url 'allergies' myuser2.id %}", {
                method: "POST",
                headers: {"Content-Type": "application/json", "X-CSRFToken": csrfToken},
                body: JSON.stringify(payload)
            }).then(r => r.json())
              .then(json => {
                  // adapt to your server's response keys; we expect something like { allergy_id: .., allergyname: .., test_level: .., severity: .. }
                  const container = document.getElementById("allergy-cards");
                  const card = document.createElement("div");
                  card.className = "card mb-3 col-12";
                  const id = json.allergy_id || ("tmp-" + Date.now());
                  card.id = `allergy-card-${id}`;
                  const severityClass = json.severity_badge_class || "bg-secondary";
                  card.innerHTML = `
                    <div class="card-body">
                      <h5 class="card-title">${json.allergyname || payload.allergyname}</h5>
                      <p class="card-text">
                        <span class="badge ${severityClass}">Test Value: ${json.test_level || payload.test_level} ${json.severity || ""}</span>
                        <button class="btn btn-sm btn-danger delete-allergy-btn" data-id="${id}">&times;</button>
                      </p>
                    </div>`;
                  container.appendChild(card);
                  attachDeleteHandler(card);
                  bootstrap.Modal.getInstance(document.getElementById('createAllergyModal')).hide();
                  allergyForm.reset();
              })
              .catch(err => console.error(err));
        });
    }

    // Attach delete handlers for allergies already on page
    document.querySelectorAll('.delete-allergy-btn').forEach(btn => {
        const card = btn.closest('.card');
        attachDeleteHandler(card);
    });

    // ---- Dynamic inputs for Restaurant modal ----
    const addMenuBtn = document.getElementById("addMenuBtn");
    const addSectionBtn = document.getElementById("addSectionBtn");
    const addFoodBtn = document.getElementById("addFoodBtn");

    if (addMenuBtn) {
        addMenuBtn.addEventListener("click", () => {
            document.getElementById("menuList").insertAdjacentHTML("beforeend",
                `<div class="mb-3 menu-item"><label class="form-label">Menu Name</label>
                 <input type="text" class="form-control menuNameInput" required></div>`);
        });
    }
    if (addSectionBtn) {
        addSectionBtn.addEventListener("click", () => {
            document.getElementById("sectionList").insertAdjacentHTML("beforeend",
                `<div class="mb-3 section-item"><label class="form-label">Section Title</label>
                 <input type="text" class="form-control sectionTitleInput" required></div>`);
        });
    }
    if (addFoodBtn) {
        addFoodBtn.addEventListener("click", () => {
            // server-rendered options inserted into the new item
            const optHtml = `{% for allergen in food_allergens %}<option value="{{ allergen.id }}">{{ allergen.allergen }}</option>{% endfor %}`;
            document.getElementById("foodList").insertAdjacentHTML("beforeend",
                `<div class="mb-3 food-item">
                    <label class="form-label">Food Name</label>
                    <input type="text" class="form-control foodNameInput" required>
                    <label class="form-label mt-2">Allergens</label>
                    <select class="form-select foodAllergensSelect" multiple>${optHtml}</select>
                 </div>`);
        });
    }

    // ---- Save Restaurant (POST) ----
    const saveRestaurantBtn = document.getElementById("saveRestaurantBtn");
    if (saveRestaurantBtn) {
        saveRestaurantBtn.addEventListener("click", () => {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const restaurantData = {
                name: document.getElementById("restaurantName").value,
                location: document.getElementById("restaurantLocation").value,
                description: document.getElementById("restaurantDescription").value,
                phone_number: document.getElementById("restaurantPhone").value,
                menus: []
            };

            // build menus -> sections -> foods based on dynamic inputs
            document.querySelectorAll(".menu-item").forEach(menuEl => {
                const menuNameEl = menuEl.querySelector(".menuNameInput");
                const menuObj = { name: menuNameEl ? menuNameEl.value : "", sections: [] };
                // For simplicity we pair every section and food into each menu (you can improve mapping logic)
                document.querySelectorAll(".section-item").forEach(sectionEl => {
                    const sectionTitleEl = sectionEl.querySelector(".sectionTitleInput");
                    const sectionObj = { title: sectionTitleEl ? sectionTitleEl.value : "", foods: [] };
                    document.querySelectorAll(".food-item").forEach(foodEl => {
                        const foodNameEl = foodEl.querySelector(".foodNameInput");
                        const sel = foodEl.querySelector(".foodAllergensSelect");
                        const allergens = sel ? Array.from(sel.selectedOptions).map(o => o.textContent) : [];
                        if (foodNameEl && foodNameEl.value) {
                            sectionObj.foods.push({ name: foodNameEl.value, allergens: allergens });
                        }
                    });
                    menuObj.sections.push(sectionObj);
                });
                restaurantData.menus.push(menuObj);
            });
 
            fetch("{% url 'restaurants' myuser2.id %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                body: JSON.stringify(restaurantData)
            }).then(r => r.json())
              .then(json => {
                  // Accept either server-created shape or fallback to using local data
                  if (json.status === "created" || json.restaurant_id || json.success) {
                      const container = document.getElementById("restaurant-cards");
                      const card = document.createElement("div");
                      card.className = "card mb-3 col-12";

                      // Build nested HTML using local restaurantData (since view only returns id)
                      const menusHtml = restaurantData.menus.map(menu => {
                          const sectionsHtml = (menu.sections || []).map(section => {
                              const foodsHtml = (section.foods || []).map(food => {
                                  const allergStr = (food.allergens && food.allergens.length)
                                      ? ` - Allergens: ${food.allergens.join(", ")}`
                                      : "";
                                  return `<li>${food.name}${allergStr}</li>`;
                              }).join("");
                              return `<div class="ms-3"><strong>Section: ${section.title}</strong><ul>${foodsHtml}</ul></div>`;
                          }).join("");
                          return `<div class="ms-3"><h5>Menu: ${menu.name}</h5>${sectionsHtml}</div>`;
                      }).join("");

                      card.innerHTML = `<div class="card-body">
                        <h4 class="card-title">${restaurantData.name}</h4>
                        <p><strong>Location:</strong> ${restaurantData.location}</p>
                        <p><strong>Description:</strong> ${restaurantData.description}</p>
                        <p><strong>Phone:</strong> ${restaurantData.phone_number}</p>
                        ${menusHtml}
                      </div>`;

                      container.appendChild(card);
                      bootstrap.Modal.getInstance(document.getElementById("restaurantModal")).hide();
                      document.getElementById("restaurantForm").reset();
                  } else {
                      console.error("Unexpected response creating restaurant:", json);
                  }
              })
              .catch(err => console.error(err));
        });
    }
});

// ---- Allergy delete handler helper ----
function attachDeleteHandler(card) {
    const btn = card.querySelector('.delete-allergy-btn');
    if (!btn) return;
    btn.addEventListener('click', function() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const allergyId = this.dataset.id;
        const url = "{% url 'delete_allergy' 0 %}".replace('0', allergyId);
        fetch(url, { method: 'DELETE', headers: { 'X-CSRFToken': csrfToken } })
            .then(r => r.json())
            .then(data => {
                if (data.success || data.status === 'deleted') {
                    card.remove();
                } else {
                    alert("Failed to delete allergy.");
                }
            }).catch(err => console.error(err));
    });
}

  document.getElementById("restaurantSearchInput").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      event.preventDefault(); // Prevent form submission if inside a form
      const query = this.value.trim();
      if (query) {
        window.location.href = `./?q=${encodeURIComponent(query)}`;
      }
    }
  });
</script>
{% endif %}
</body>
</html>
